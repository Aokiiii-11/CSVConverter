<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV 转 Excel (纯前端版)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; line-height: 1.6; }
        .container { background: #f9f9f9; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #333; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input[type="file"] { display: block; width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        select { display: block; width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; width: 100%; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .note { font-size: 0.9rem; color: #666; margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; }
        .error { color: red; margin-bottom: 1rem; display: none; padding: 0.5rem; background: #ffe6e6; border-radius: 4px; }
        .success { color: green; margin-bottom: 1rem; display: none; padding: 0.5rem; background: #e6ffe6; border-radius: 4px; }
        #loading { display: none; text-align: center; margin-top: 1rem; }
    </style>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>CSV 转 Excel</h1>
        <p>纯前端处理，文件不会上传到服务器。<br>所有单元格将强制转为文本格式，防止长数字精度丢失。</p>
        
        <div id="error-msg" class="error"></div>
        <div id="success-msg" class="success"></div>

        <div class="form-group">
            <label for="file">选择 CSV 文件:</label>
            <input type="file" id="file" accept=".csv">
        </div>
        
        <div class="form-group">
            <label for="encoding">文件编码:</label>
            <select id="encoding">
                <option value="UTF-8">UTF-8 (默认)</option>
                <option value="GBK">GBK (Windows 常见)</option>
                <option value="ISO-8859-1">Latin-1</option>
            </select>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="verify" checked>
                导出前校验一致性（更慢）
            </label>
        </div>

        <button id="convert-btn" onclick="convert()">开始转换并下载</button>

        <div class="form-group" style="margin-top: 1rem;">
            <button id="test-btn" onclick="selfTest()">运行内置自测</button>
        </div>
        
        <div id="loading">正在转换中，请稍候...</div>

        <div class="note">
            <strong>隐私说明：</strong> 本工具运行在您的浏览器中，文件不会上传到任何服务器，请放心使用。<br>
            <strong>使用提示：</strong> 转换大文件可能会导致浏览器短暂卡顿，属正常现象。
        </div>
    </div>

    <script>
        function showError(msg) {
            const el = document.getElementById('error-msg');
            if (!msg) {
                el.textContent = '';
                el.style.display = 'none';
                return;
            }
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('success-msg').style.display = 'none';
        }

        function showSuccess(msg) {
            const el = document.getElementById('success-msg');
            if (!msg) {
                el.textContent = '';
                el.style.display = 'none';
                return;
            }
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('error-msg').style.display = 'none';
        }

        function normalizeMatrix(matrix) {
            const rows = Array.isArray(matrix) ? matrix : [];
            let maxCols = 0;
            for (const row of rows) {
                const cols = Array.isArray(row) ? row.length : 0;
                if (cols > maxCols) maxCols = cols;
            }

            const normalized = [];
            for (const row of rows) {
                const arr = Array.isArray(row) ? row : [];
                const out = new Array(maxCols);
                for (let i = 0; i < maxCols; i += 1) {
                    const v = arr[i];
                    out[i] = v == null ? '' : String(v);
                }
                normalized.push(out);
            }
            return { normalized, maxCols };
        }

        function findFirstMismatch(a, b) {
            const rows = Math.max(a.length, b.length);
            for (let r = 0; r < rows; r += 1) {
                const rowA = a[r] || [];
                const rowB = b[r] || [];
                const cols = Math.max(rowA.length, rowB.length);
                for (let c = 0; c < cols; c += 1) {
                    const va = rowA[c] == null ? '' : String(rowA[c]);
                    const vb = rowB[c] == null ? '' : String(rowB[c]);
                    if (va !== vb) {
                        return { r, c, va, vb };
                    }
                }
            }
            return null;
        }

        function createRunId() {
            return String(Date.now()) + '-' + Math.random().toString(16).slice(2);
        }

        function safePreview(value, maxLen) {
            const s = value == null ? '' : String(value);
            if (s.length <= maxLen) return s;
            return s.slice(0, maxLen) + '…(len=' + s.length + ')';
        }

        function matrixShape(matrix) {
            const rows = Array.isArray(matrix) ? matrix.length : 0;
            const cols = rows > 0 && Array.isArray(matrix[0]) ? matrix[0].length : 0;
            return { rows, cols };
        }

        function convert() {
            const fileInput = document.getElementById('file');
            const encodingInput = document.getElementById('encoding');
            const verifyInput = document.getElementById('verify');
            const file = fileInput.files[0];

            if (!file) {
                showError("请先选择一个 CSV 文件");
                return;
            }

            document.getElementById('convert-btn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            showSuccess('');
            showError('');

            const encoding = encodingInput.value;
            const runId = createRunId();
            const t0 = performance.now();

            Papa.parse(file, {
                encoding: encoding,
                delimiter: '',
                dynamicTyping: false,
                skipEmptyLines: false,
                transform: function(value) {
                    return value == null ? '' : String(value);
                },
                complete: function(results) {
                    console.groupCollapsed('[CSVConverter] convert ' + runId);
                    try {
                        console.info('input', { name: file.name, size: file.size, type: file.type, encoding, verify: !!(verifyInput && verifyInput.checked) });
                        console.info('timing(ms)', { started: 0, parsed: Math.round(performance.now() - t0) });

                        if (results.errors && results.errors.length > 0) {
                            console.warn('parseErrors', { count: results.errors.length, sample: results.errors.slice(0, 5) });
                        }
                        if (results.errors.length > 0 && results.data.length === 0) {
                            throw new Error("CSV 解析失败: " + JSON.stringify(results.errors));
                        }

                        const t1 = performance.now();
                        const inputMatrix = normalizeMatrix(results.data).normalized;
                        if (inputMatrix.length === 0) {
                            throw new Error('CSV 为空');
                        }

                        const inputShape = matrixShape(inputMatrix);
                        console.info('matrix', inputShape);

                        const wb = XLSX.utils.book_new();

                        const ws = XLSX.utils.aoa_to_sheet(inputMatrix);

                        if (ws['!ref']) {
                            const range = XLSX.utils.decode_range(ws['!ref']);
                            for (let R = range.s.r; R <= range.e.r; R += 1) {
                                for (let C = range.s.c; C <= range.e.c; C += 1) {
                                    const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                                    const cell = ws[cell_ref];
                                    if (!cell) continue;
                                    cell.v = cell.v == null ? '' : String(cell.v);
                                    cell.t = 's';
                                }
                            }
                        }

                        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                        // 生成文件名
                        let outputFilename = file.name;
                        if (outputFilename.toLowerCase().endsWith('.csv')) {
                            outputFilename = outputFilename.slice(0, -4);
                        }
                        outputFilename += '.xlsx';

                        const tWriteStart = performance.now();
                        const out = XLSX.write(wb, { bookType: 'xlsx', type: 'array', compression: true, bookSST: true });
                        const tWriteEnd = performance.now();
                        console.info('xlsxBytes', { byteLength: out.byteLength });
                        console.info('timing(ms)', { normalize: Math.round(t1 - t0), write: Math.round(tWriteEnd - tWriteStart) });

                        if (verifyInput && verifyInput.checked) {
                            const tVerifyStart = performance.now();
                            const wb2 = XLSX.read(out, { type: 'array' });
                            const sheetName = wb2.SheetNames[0];
                            const ws2 = wb2.Sheets[sheetName];
                            const matrix2 = XLSX.utils.sheet_to_json(ws2, { header: 1, raw: false, defval: '' });
                            const a = normalizeMatrix(inputMatrix).normalized;
                            const b = normalizeMatrix(matrix2).normalized;

                            console.info('verify.readBack', { sheetName, shape: matrixShape(b) });
                            const mismatch = findFirstMismatch(a, b);
                            if (mismatch) {
                                console.error('verify.mismatch', {
                                    row: mismatch.r + 1,
                                    col: mismatch.c + 1,
                                    csv: safePreview(mismatch.va, 200),
                                    xlsx: safePreview(mismatch.vb, 200)
                                });
                                throw new Error(`一致性校验失败：第 ${mismatch.r + 1} 行第 ${mismatch.c + 1} 列不一致（CSV="${mismatch.va}", XLSX="${mismatch.vb}"）`);
                            }

                            const tVerifyEnd = performance.now();
                            console.info('verify.pass', { ms: Math.round(tVerifyEnd - tVerifyStart) });
                        }

                        const blob = new Blob([out], {
                            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = outputFilename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);

                        console.info('download', { filename: outputFilename });
                        console.info('timing(ms)', { total: Math.round(performance.now() - t0) });
                        
                        showSuccess(`转换成功！文件 ${outputFilename} 已开始下载。`);
                    } catch (e) {
                        console.error(e);
                        showError("转换出错: " + e.message);
                    } finally {
                        console.groupEnd();
                        document.getElementById('convert-btn').disabled = false;
                        document.getElementById('loading').style.display = 'none';
                    }
                },
                error: function(err) {
                    console.error('[CSVConverter] convert ' + runId, err);
                    showError("读取文件失败: " + err.message);
                    document.getElementById('convert-btn').disabled = false;
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }

        function selfTest() {
            const runId = createRunId();
            const t0 = performance.now();
            const sample = [
                'id,name,amount,code,note',
                '1,张三,123,000123,普通行',
                '2,李四,"1,234","ABC,DEF",含逗号',
                '3,,,"",空值和空字符串',
                ',,,,' ,
                '4,"含引号""内容""",999999999999999999,END,长数字和引号'
            ].join('\n');

            showError('');
            showSuccess('');

            const loading = document.getElementById('loading');
            const btn = document.getElementById('test-btn');
            if (btn) btn.disabled = true;
            loading.style.display = 'block';

            Papa.parse(sample, {
                delimiter: '',
                dynamicTyping: false,
                skipEmptyLines: false,
                transform: function(value) {
                    return value == null ? '' : String(value);
                },
                complete: function(results) {
                    console.groupCollapsed('[CSVConverter] selfTest ' + runId);
                    try {
                        console.info('timing(ms)', { started: 0, parsed: Math.round(performance.now() - t0) });

                        if (results.errors && results.errors.length > 0) {
                            console.warn('parseErrors', { count: results.errors.length, sample: results.errors.slice(0, 5) });
                        }
                        if (results.errors.length > 0 && results.data.length === 0) {
                            throw new Error('CSV 解析失败: ' + JSON.stringify(results.errors));
                        }

                        const inputMatrix = normalizeMatrix(results.data).normalized;
                        if (inputMatrix.length === 0) {
                            throw new Error('CSV 为空');
                        }

                        console.info('matrix', matrixShape(inputMatrix));

                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.aoa_to_sheet(inputMatrix);

                        if (ws['!ref']) {
                            const range = XLSX.utils.decode_range(ws['!ref']);
                            for (let R = range.s.r; R <= range.e.r; R += 1) {
                                for (let C = range.s.c; C <= range.e.c; C += 1) {
                                    const cellRef = XLSX.utils.encode_cell({ c: C, r: R });
                                    const cell = ws[cellRef];
                                    if (!cell) continue;
                                    cell.v = cell.v == null ? '' : String(cell.v);
                                    cell.t = 's';
                                }
                            }
                        }

                        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

                        const out = XLSX.write(wb, { bookType: 'xlsx', type: 'array', compression: true, bookSST: true });

                        console.info('xlsxBytes', { byteLength: out.byteLength });

                        const wb2 = XLSX.read(out, { type: 'array' });
                        const sheetName = wb2.SheetNames[0];
                        const ws2 = wb2.Sheets[sheetName];
                        const matrix2 = XLSX.utils.sheet_to_json(ws2, { header: 1, raw: false, defval: '' });

                        const a = normalizeMatrix(inputMatrix).normalized;
                        const b = normalizeMatrix(matrix2).normalized;
                        const mismatch = findFirstMismatch(a, b);

                        if (mismatch) {
                            console.error('verify.mismatch', {
                                row: mismatch.r + 1,
                                col: mismatch.c + 1,
                                csv: safePreview(mismatch.va, 200),
                                xlsx: safePreview(mismatch.vb, 200)
                            });
                            throw new Error('自测失败：第 ' + (mismatch.r + 1) + ' 行第 ' + (mismatch.c + 1) + ' 列不一致（CSV="' + mismatch.va + '", XLSX="' + mismatch.vb + '"）');
                        }

                        console.info('verify.pass', { totalMs: Math.round(performance.now() - t0) });

                        showSuccess('自测通过：示例 CSV 与生成的 Excel 内容完全一致。');
                    } catch (e) {
                        console.error(e);
                        showError('自测失败: ' + e.message);
                    } finally {
                        console.groupEnd();
                        if (btn) btn.disabled = false;
                        loading.style.display = 'none';
                    }
                },
                error: function(err) {
                    console.error('[CSVConverter] selfTest ' + runId, err);
                    if (btn) btn.disabled = false;
                    loading.style.display = 'none';
                    showError('自测读取失败: ' + err.message);
                }
            });
        }
    </script>
</body>
</html>
