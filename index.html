<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV 转 Excel (纯前端版)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; line-height: 1.6; }
        .container { background: #f9f9f9; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #333; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input[type="file"] { display: block; width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        select { display: block; width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; width: 100%; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .note { font-size: 0.9rem; color: #666; margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; }
        .error { color: red; margin-bottom: 1rem; display: none; padding: 0.5rem; background: #ffe6e6; border-radius: 4px; }
        .success { color: green; margin-bottom: 1rem; display: none; padding: 0.5rem; background: #e6ffe6; border-radius: 4px; }
        #loading { display: none; text-align: center; margin-top: 1rem; }
    </style>
    <!-- 引入必要的库 -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>CSV 转 Excel</h1>
        <p>纯前端处理，文件不会上传到服务器。<br>所有单元格将强制转为文本格式，防止长数字精度丢失。</p>
        
        <div id="error-msg" class="error"></div>
        <div id="success-msg" class="success"></div>

        <div class="form-group">
            <label for="file">选择 CSV 文件:</label>
            <input type="file" id="file" accept=".csv">
        </div>
        
        <div class="form-group">
            <label for="encoding">文件编码:</label>
            <select id="encoding">
                <option value="UTF-8">UTF-8 (默认)</option>
                <option value="GBK">GBK (Windows 常见)</option>
                <option value="ISO-8859-1">Latin-1</option>
            </select>
        </div>

        <button id="convert-btn" onclick="convert()">开始转换并下载</button>
        
        <div id="loading">正在转换中，请稍候...</div>

        <div class="note">
            <strong>隐私说明：</strong> 本工具运行在您的浏览器中，文件不会上传到任何服务器，请放心使用。<br>
            <strong>使用提示：</strong> 转换大文件可能会导致浏览器短暂卡顿，属正常现象。
        </div>
    </div>

    <script>
        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('success-msg').style.display = 'none';
        }

        function showSuccess(msg) {
            const el = document.getElementById('success-msg');
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('error-msg').style.display = 'none';
        }

        function convert() {
            const fileInput = document.getElementById('file');
            const encodingInput = document.getElementById('encoding');
            const file = fileInput.files[0];

            if (!file) {
                showError("请先选择一个 CSV 文件");
                return;
            }

            document.getElementById('convert-btn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            showSuccess(""); 
            showError(""); // 清除旧消息

            const encoding = encodingInput.value;

            // 使用 PapaParse 解析 CSV
            Papa.parse(file, {
                encoding: encoding,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        if (results.errors.length > 0 && results.data.length === 0) {
                            throw new Error("CSV 解析失败: " + JSON.stringify(results.errors));
                        }

                        const data = results.data;
                        
                        // 创建 Workbook
                        const wb = XLSX.utils.book_new();
                        
                        // 转换为 Sheet，强制所有单元格为文本类型
                        // 方法：先生成 sheet，然后遍历修改类型
                        const ws = XLSX.utils.aoa_to_sheet(data);

                        // 获取 sheet 的范围
                        const range = XLSX.utils.decode_range(ws['!ref']);
                        
                        // 遍历所有单元格，强制设置为文本格式
                        for(let R = range.s.r; R <= range.e.r; ++R) {
                            for(let C = range.s.c; C <= range.e.c; ++C) {
                                const cell_address = {c:C, r:R};
                                const cell_ref = XLSX.utils.encode_cell(cell_address);
                                
                                if(!ws[cell_ref]) continue;
                                
                                // 强制类型为 String ('s')，并设置格式为 Text ('@')
                                ws[cell_ref].t = 's';
                                ws[cell_ref].z = '@';
                            }
                        }

                        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                        // 生成文件名
                        let outputFilename = file.name;
                        if (outputFilename.toLowerCase().endsWith('.csv')) {
                            outputFilename = outputFilename.slice(0, -4);
                        }
                        outputFilename += '.xlsx';

                        // 下载
                        XLSX.writeFile(wb, outputFilename);
                        
                        showSuccess(`转换成功！文件 ${outputFilename} 已开始下载。`);
                    } catch (e) {
                        console.error(e);
                        showError("转换出错: " + e.message);
                    } finally {
                        document.getElementById('convert-btn').disabled = false;
                        document.getElementById('loading').style.display = 'none';
                    }
                },
                error: function(err) {
                    showError("读取文件失败: " + err.message);
                    document.getElementById('convert-btn').disabled = false;
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
